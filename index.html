<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-en="Global TimeSync - World Clock" data-zh="全球时间同步 - 世界时钟">Global TimeSync - World Clock</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- SortableJS for drag-and-drop functionality -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /*
        * CSS will go here to define the graphical designer's aesthetic.
        * Focusing on clean lines, good typography (Inter font suggested),
        * ample whitespace, subtle transitions, and intuitive layout.
        * Variables for colors will be used for easy theme switching.
        */
        :root {
            --background-light: #f8f8f8;
            --text-light: #333;
            --card-background-light: #ffffff;
            --border-light: #e0e0e0;

            --background-dark: #1a1a1a;
            --text-dark: #e0e0e0;
            --card-background-dark: #2a2a2a;
            --border-dark: #3a3a3a;

            --primary-color: #007bff; /* A nice blue for accents */
            --secondary-color: #6c757d; /* Grey for less prominent elements */

            --font-family: 'Inter', sans-serif;
            --border-radius: 8px;
            --spacing-unit: 16px;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-light);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }

        /* Utility classes for layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: calc(2 * var(--spacing-unit));
            width: 100%;
            box-sizing: border-box;
        }

        /* Header */
        header {
            background-color: var(--card-background-light);
            border-bottom: 1px solid var(--border-light);
            padding: var(--spacing-unit) 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        body.dark-mode header {
            background-color: var(--card-background-dark);
            border-color: var(--border-dark);
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
        }

        .controls {
            display: flex;
            gap: var(--spacing-unit);
            align-items: center;
        }

        .theme-switcher {
            display: flex;
            align-items: center;
            gap: 8px; /* Space between text and toggle */
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--secondary-color);
            transition: 0.4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(16px);
        }

        select, input[type="text"], input[type="number"] {
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
            background-color: var(--card-background-light);
            color: var(--text-light);
            font-size: 1em;
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode select, body.dark-mode input[type="text"], body.dark-mode input[type="number"] {
            border: 1px solid var(--border-dark);
            background-color: var(--card-background-dark);
            color: var(--text-dark);
        }

        /* Main Content */
        main {
            flex-grow: 1;
            padding: var(--spacing-unit) 0;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-unit);
            align-items: start; /* Align items to the top */
        }

        /* Time Card */
        .time-card {
            background-color: var(--card-background-light);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: calc(1.5 * var(--spacing-unit));
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: calc(0.5 * var(--spacing-unit));
            cursor: grab; /* Indicates draggable */
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            position: relative; /* For fullscreen button positioning */
        }

        body.dark-mode .time-card {
            background-color: var(--card-background-dark);
            border-color: var(--border-dark);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .time-card:active {
            cursor: grabbing;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1); /* Lift effect on drag */
        }

        .time-card h3 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 500;
            color: var(--primary-color);
        }

        .time-card .current-time {
            font-size: 3.5em; /* Increased size */
            font-weight: 700;
            margin-top: 5px;
            color: var(--text-light); /* Or a slightly different shade */
            transition: color 0.3s ease;
        }

        body.dark-mode .time-card .current-time {
            color: var(--text-dark);
        }

        .time-card .date-display {
            font-size: 0.9em;
            color: var(--secondary-color);
        }

        .time-card .offset-display {
            font-size: 0.85em;
            color: var(--secondary-color);
        }

        .remove-card {
            align-self: flex-end; /* Pushes button to the right */
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            transition: color 0.2s ease;
        }

        .remove-card:hover {
            color: #dc3545; /* Red for delete */
        }

        /* Add Region Section */
        .add-region-section {
            background-color: var(--card-background-light);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: calc(1.5 * var(--spacing-unit));
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: var(--spacing-unit);
            display: flex;
            gap: var(--spacing-unit);
            flex-wrap: wrap;
            align-items: center;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        body.dark-mode .add-region-section {
            background-color: var(--card-background-dark);
            border-color: var(--border-dark);
        }

        .add-region-section label {
            font-weight: 500;
        }

        .add-region-section button {
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }

        .add-region-section button:hover {
            background-color: #0056b3;
        }

        /* Countdown & Stopwatch Sections */
        .utility-section {
            background-color: var(--card-background-light);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: calc(1.5 * var(--spacing-unit));
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-top: var(--spacing-unit);
            text-align: center;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            position: relative; /* For fullscreen button positioning */
        }

        body.dark-mode .utility-section {
            background-color: var(--card-background-dark);
            border-color: var(--border-dark);
        }

        .utility-section h2 {
            margin-top: 0;
            font-size: 1.5em;
            color: var(--primary-color);
        }

        .timer-display {
            font-size: 3em;
            font-weight: 700;
            margin: 20px 0;
            color: var(--text-light);
            transition: color 0.3s ease;
        }

        body.dark-mode .timer-display {
            color: var(--text-dark);
        }

        .timer-controls button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }

        .timer-controls .start-btn {
            background-color: #28a745; /* Green */
            color: white;
        }
        .timer-controls .start-btn:hover { background-color: #218838; }

        .timer-controls .pause-btn {
            background-color: #ffc107; /* Yellow */
            color: #333;
        }
        .timer-controls .pause-btn:hover { background-color: #e0a800; }

        .timer-controls .reset-btn {
            background-color: #dc3545; /* Red */
            color: white;
        }
        .timer-controls .reset-btn:hover { background-color: #c82333; }

        /* Footer */
        footer {
            text-align: center;
            padding: var(--spacing-unit) 0;
            margin-top: auto; /* Pushes footer to the bottom */
            font-size: 0.9em;
            color: var(--secondary-color);
            border-top: 1px solid var(--border-light);
            transition: border-color 0.3s ease;
        }

        body.dark-mode footer {
            border-color: var(--border-dark);
        }

        /* Fullscreen Button */
        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 40px; /* Adjusted to make space for remove button */
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 1em;
            padding: 5px;
            transition: color 0.2s ease;
            line-height: 1; /* Ensure icon is centered */
        }

        .fullscreen-btn:hover {
            color: var(--primary-color);
        }

        /* Fullscreen Overlay Styling */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--background-light);
            color: var(--text-light);
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode .fullscreen-overlay {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }

        .fullscreen-overlay .current-time,
        .fullscreen-overlay .timer-display {
            font-size: 8em; /* Much larger for full screen */
            margin-bottom: 20px;
        }

        .fullscreen-overlay h3,
        .fullscreen-overlay h2 {
            font-size: 3em; /* Larger title for full screen */
            margin-bottom: 10px;
        }

        .fullscreen-overlay .date-display,
        .fullscreen-overlay .offset-display {
            font-size: 1.5em; /* Larger details for full screen */
        }

        .fullscreen-overlay .timer-controls {
            display: flex;
            flex-direction: row; /* Keep controls in a row */
            gap: 10px;
            margin-top: 20px;
        }

        /* Hide other content when in fullscreen */
        body.body--fullscreen > *:not(.fullscreen-overlay) {
            display: none !important;
        }
        body.body--fullscreen header,
        body.body--fullscreen main,
        body.body--fullscreen footer {
            display: none !important;
        }

        /* Close button for fullscreen - made smaller and less prominent */
        .fullscreen-close-btn {
            position: absolute;
            top: 10px; /* Closer to the corner */
            right: 10px; /* Closer to the corner */
            background: none;
            border: none;
            color: var(--secondary-color); /* Less prominent color */
            font-size: 1.2em; /* Smaller font size */
            cursor: pointer;
            z-index: 1000;
            transition: color 0.2s ease;
            padding: 5px 10px; /* Smaller padding */
            border-radius: var(--border-radius); /* Rounded corners */
        }

        body.dark-mode .fullscreen-close-btn {
            color: var(--secondary-color);
        }

        .fullscreen-close-btn:hover {
            color: var(--primary-color); /* Still provides hover feedback */
            background-color: rgba(0,0,0,0.1); /* Subtle background on hover */
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1 data-en="Global TimeSync" data-zh="全球时间同步">Global TimeSync</h1>
            <div class="controls">
                <div class="theme-switcher">
                    <span data-en="Light" data-zh="浅色">浅色</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="slider"></span>
                    </label>
                    <span data-en="Dark" data-zh="深色">深色</span>
                </div>
                <select id="language-switcher">
                    <option value="en" selected data-en="English" data-zh="英语">English</option>
                    <option value="zh" data-en="Chinese" data-zh="中文">中文</option>
                </select>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Add Region Section -->
        <section class="add-region-section">
            <label for="timezone-search-input" data-en="Search Timezone:" data-zh="搜索时区:">搜索时区:</label>
            <input type="text" id="timezone-search-input" placeholder="Search for a city or timezone..." data-en-placeholder="Search for a city or timezone..." data-zh-placeholder="搜索城市或时区...">
            <label for="timezone-select" data-en="Select Timezone:" data-zh="选择时区:">选择时区:</label>
            <select id="timezone-select">
                <!-- Options will be populated dynamically by JavaScript -->
                <option value="" disabled selected data-en="Select a city/timezone..." data-zh="选择城市/时区...">选择城市/时区...</option>
                <!-- Timezones populated by JS -->
            </select>
            <button id="add-timezone-btn" data-en="Add" data-zh="添加">添加</button>
        </section>

        <!-- World Clock Dashboard -->
        <section class="dashboard" id="world-clock-dashboard">
            <!-- Initial Time cards, their titles will be set by JS on load -->
            <div class="time-card" data-timezone="Australia/Melbourne">
                <h3 data-timezone-name="Australia/Melbourne"></h3>
                <span class="current-time">00:00:00</span>
                <span class="date-display"></span>
                <span class="offset-display">GMT+10:00</span>
                <button class="remove-card" aria-label="Remove card">&times;</button>
                <button class="fullscreen-btn" data-en="&#x26F6;" data-zh="&#x26F6;" aria-label="Full screen">&#x26F6;</button> <!-- Fullscreen icon -->
            </div>
            <div class="time-card" data-timezone="America/Los_Angeles">
                <h3 data-timezone-name="America/Los_Angeles"></h3>
                <span class="current-time">00:00:00</span>
                <span class="date-display"></span>
                <span class="offset-display">GMT-07:00</span>
                <button class="remove-card" aria-label="Remove card">&times;</button>
                <button class="fullscreen-btn" data-en="&#x26F6;" data-zh="&#x26F6;" aria-label="Full screen">&#x26F6;</button> <!-- Fullscreen icon -->
            </div>
        </section>

        <hr> <!-- Separator for visual clarity -->

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-unit);">
            <!-- Countdown Section -->
            <section class="utility-section" id="countdown-section">
                <h2 data-en="Countdown Timer" data-zh="倒计时">倒计时</h2>
                <div class="timer-display" id="countdown-display">00:00:00</div>
                <div class="timer-controls">
                    <input type="number" id="countdown-minutes" placeholder="Minutes" min="0" style="width: 80px; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-light);">
                    <button class="start-btn" id="countdown-start" data-en="Start" data-zh="开始">开始</button>
                    <button class="pause-btn" id="countdown-pause" data-en="Pause" data-zh="暂停">暂停</button>
                    <button class="reset-btn" id="countdown-reset" data-en="Reset" data-zh="重置">重置</button>
                </div>
                <button class="fullscreen-btn" data-en="&#x26F6;" data-zh="&#x26F6;" aria-label="Full screen">&#x26F6;</button> <!-- Fullscreen icon -->
            </section>

            <!-- Stopwatch Section -->
            <section class="utility-section" id="stopwatch-section">
                <h2 data-en="Stopwatch" data-zh="秒表">秒表</h2>
                <div class="timer-display" id="stopwatch-display">00:00:00</div>
                <div class="timer-controls">
                    <button class="start-btn" id="stopwatch-start" data-en="Start" data-zh="开始">开始</button>
                    <button class="pause-btn" id="stopwatch-pause" data-en="Pause" data-zh="暂停">暂停</button>
                    <button class="reset-btn" id="stopwatch-reset" data-en="Reset" data-zh="重置">重置</button>
                </div>
                <button class="fullscreen-btn" data-en="&#x26F6;" data-zh="&#x26F6;" aria-label="Full screen">&#x26F6;</button> <!-- Fullscreen icon -->
            </section>
        </div>
    </main>

    <footer>
        <p data-en="&copy; 2025 Global TimeSync. All rights reserved." data-zh="&copy; 2025 全球时间同步。保留所有权利。">&copy; 2025 Global TimeSync. All rights reserved.</p>
    </footer>

    <!-- JavaScript will go here -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            const languageSwitcher = document.getElementById('language-switcher');
            const elementsToTranslate = document.querySelectorAll('[data-en], [data-zh], [data-en-placeholder], [data-zh-placeholder]');
            const worldClockDashboard = document.getElementById('world-clock-dashboard');
            const timezoneSelect = document.getElementById('timezone-select');
            const addTimezoneBtn = document.getElementById('add-timezone-btn');
            const timezoneSearchInput = document.getElementById('timezone-search-input');

            // --- Localized messages for displayMessage function ---
            const messages = {
                'invalidCountdownInput': { en: 'Please enter a valid number of minutes for the countdown.', zh: '请输入有效的倒计时分钟数。' },
                'countdownFinished': { en: 'Countdown finished!', zh: '倒计时结束！' },
                'timezoneAlreadyAdded': { en: 'This timezone is already added.', zh: '此时区已添加。' },
                'selectTimezoneToAdd': { en: 'Please select a timezone to add.', zh: '请选择要添加的时区。' },
                'exitFullscreen': { en: 'Exit', zh: '退出' } // Changed to 'Exit' for a smaller text
            };

            // --- Theme Toggle ---
            themeToggle.addEventListener('change', () => {
                body.classList.toggle('dark-mode', themeToggle.checked);
                localStorage.setItem('theme', themeToggle.checked ? 'dark' : 'light');
            });

            // Load saved theme preference
            if (localStorage.getItem('theme') === 'dark') {
                body.classList.add('dark-mode');
                themeToggle.checked = true;
            }

            // --- Language Switching ---
            const setLanguage = (lang) => {
                // Translate static elements
                elementsToTranslate.forEach(element => {
                    if (element.tagName === 'OPTION') {
                        const timezoneValue = element.value;
                        if (timezoneValue && timezoneDisplayNames[timezoneValue]) {
                            element.textContent = timezoneDisplayNames[timezoneValue][lang] || timezoneDisplayNames[timezoneValue]['en'];
                        } else if (element.hasAttribute(`data-${lang}`)) {
                            element.textContent = element.dataset[lang];
                        }
                    } else if (element.hasAttribute(`data-${lang}`)) {
                        element.textContent = element.dataset[lang];
                    }
                    if (element.hasAttribute(`data-${lang}-placeholder`)) {
                        element.placeholder = element.dataset[`${lang}-placeholder`];
                    }
                });

                // Translate titles of existing time cards
                document.querySelectorAll('.time-card h3[data-timezone-name]').forEach(h3 => {
                    const timezoneKey = h3.dataset.timezoneName;
                    if (timezoneDisplayNames[timezoneKey]) {
                        h3.textContent = timezoneDisplayNames[timezoneKey][lang] || timezoneDisplayNames[timezoneKey]['en'];
                    }
                });

                // Update dates and weekdays on all time cards
                updateClocks();

                // Update fullscreen button text if it's an emoji/symbol, or if it's text based
                document.querySelectorAll('.fullscreen-btn').forEach(btn => {
                    if (btn.dataset[lang]) { // Check if it has a localized data attribute
                        btn.textContent = btn.dataset[lang];
                    }
                });
                // Update close fullscreen button text
                const fullscreenCloseBtn = document.querySelector('.fullscreen-close-btn');
                if (fullscreenCloseBtn) {
                    fullscreenCloseBtn.textContent = messages['exitFullscreen'][lang] || messages['exitFullscreen']['en'];
                }
            };

            languageSwitcher.addEventListener('change', (event) => {
                setLanguage(event.target.value);
                localStorage.setItem('language', event.target.value);
                populateTimezoneSelect(timezoneSearchInput.value); // Re-populate to update options
            });

            // Load saved language preference and apply
            const savedLanguage = localStorage.getItem('language') || 'en';
            languageSwitcher.value = savedLanguage;
            // setLanguage(savedLanguage) will be called after initial populate and initial card title update

            // --- Dynamic Time Cards ---
            const updateClocks = () => {
                const currentLang = languageSwitcher.value; // Get current language for date formatting
                document.querySelectorAll('.time-card').forEach(card => {
                    const timezone = card.dataset.timezone;
                    const now = new Date();
                    const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: timezone };
                    // Use currentLang for date formatting
                    const optionsDate = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', timeZone: timezone };

                    const currentTime = now.toLocaleTimeString('en-US', optionsTime); // Time format is generally consistent
                    const currentDate = now.toLocaleDateString(currentLang, optionsDate); // Localize date and weekday

                    card.querySelector('.current-time').textContent = currentTime;
                    card.querySelector('.date-display').textContent = currentDate;

                    try {
                        const dateTimeFormat = new Intl.DateTimeFormat('en-US', {
                            timeZone: timezone,
                            timeZoneName: 'longOffset'
                        });
                        const parts = dateTimeFormat.formatToParts(now);
                        const timeZoneNamePart = parts.find(part => part.type === 'timeZoneName');
                        card.querySelector('.offset-display').textContent = timeZoneNamePart ? timeZoneNamePart.value : '';
                    } catch (e) {
                        console.error("Error getting timezone offset for", timezone, e);
                        card.querySelector('.offset-display').textContent = 'Invalid Timezone';
                    }
                });
            };

            setInterval(updateClocks, 1000); // Update every second
            updateClocks(); // Initial call

            // --- Timezone Data and Localized Names ---
            const timezoneDisplayNames = {
                "Africa/Algiers": { en: "Algiers", zh: "阿尔及尔" },
                "Africa/Cairo": { en: "Cairo", zh: "开罗" },
                "Africa/Casablanca": { en: "Casablanca", zh: "卡萨布兰卡" },
                "Africa/Johannesburg": { en: "Johannesburg", zh: "约翰内斯堡" },
                "America/Anchorage": { en: "Anchorage", zh: "安克雷奇" },
                "America/Argentina/Buenos_Aires": { en: "Buenos Aires", zh: "布宜诺斯艾利斯" },
                "America/Bogota": { en: "Bogota", zh: "波哥大" },
                "America/Caracas": { en: "Caracas", zh: "加拉加斯" },
                "America/Chicago": { en: "Chicago", zh: "芝加哥" },
                "America/Denver": { en: "Denver", zh: "丹佛" },
                "America/Detroit": { en: "Detroit", zh: "底特律" },
                "America/El_Salvador": { en: "El Salvador", zh: "萨尔瓦多" },
                "America/Halifax": { en: "Halifax", zh: "哈利法克斯" },
                "America/Havana": { en: "Havana", zh: "哈瓦那" },
                "America/Indianapolis": { en: "Indianapolis", zh: "印第安纳波利斯" },
                "America/Jamaica": { en: "Jamaica", zh: "牙买加" },
                "America/Juneau": { en: "Juneau", zh: "朱诺" },
                "America/Lima": { en: "Lima", zh: "利马" },
                "America/Los_Angeles": { en: "Los Angeles", zh: "洛杉矶" },
                "America/Mexico_City": { en: "Mexico City", zh: "墨西哥城" },
                "America/New_York": { en: "New York", zh: "纽约" },
                "America/Noronha": { en: "Noronha", zh: "诺罗尼亚" },
                "America/Phoenix": { en: "Phoenix", zh: "凤凰城" },
                "America/Sao_Paulo": { en: "Sao Paulo", zh: "圣保罗" },
                "America/St_Johns": { en: "St. John's", zh: "圣约翰斯" },
                "America/Vancouver": { en: "Vancouver", zh: "温哥华" },
                "Asia/Baghdad": { en: "Baghdad", zh: "巴格达" },
                "Asia/Bangkok": { en: "Bangkok", zh: "曼谷" },
                "Asia/Beirut": { en: "Beirut", zh: "贝鲁特" },
                "Asia/Colombo": { en: "Colombo", zh: "科伦坡" },
                "Asia/Damascus": { en: "Damascus", zh: "大马士革" },
                "Asia/Dhaka": { en: "Dhaka", zh: "达卡" },
                "Asia/Dubai": { en: "Dubai", zh: "迪拜" },
                "Asia/Hong_Kong": { en: "Hong Kong", zh: "香港" },
                "Asia/Jakarta": { en: "Jakarta", zh: "雅加达" },
                "Asia/Jerusalem": { en: "Jerusalem", zh: "耶路撒冷" },
                "Asia/Kabul": { en: "Kabul", zh: "喀布尔" },
                "Asia/Karachi": { en: "Karachi", zh: "卡拉奇" },
                "Asia/Kathmandu": { en: "Kathmandu", zh: "加德满都" },
                "Asia/Kolkata": { en: "Kolkata", zh: "加尔各答" },
                "Asia/Kuala_Lumpur": { en: "Kuala Lumpur", zh: "吉隆坡" },
                "Asia/Manila": { en: "Manila", zh: "马尼拉" },
                "Asia/Nicosia": { en: "Nicosia", zh: "尼科西亚" },
                "Asia/Qatar": { en: "Qatar", zh: "卡塔尔" },
                "Asia/Riyadh": { en: "Riyadh", zh: "利雅得" },
                "Asia/Seoul": { en: "Seoul", zh: "首尔" },
                "Asia/Shanghai": { en: "Shanghai", zh: "上海" },
                "Asia/Singapore": { en: "Singapore", zh: "新加坡" },
                "Asia/Taipei": { en: "Taipei", zh: "台北" },
                "Asia/Tehran": { en: "Tehran", zh: "德黑兰" },
                "Asia/Tokyo": { en: "Tokyo", zh: "东京" },
                "Asia/Ulaanbaatar": { en: "Ulaanbaatar", zh: "乌兰巴托" },
                "Asia/Vladivostok": { en: "Vladivostok", zh: "符拉迪沃斯托克" },
                "Atlantic/Azores": { en: "Azores", zh: "亚速尔群岛" },
                "Atlantic/Cape_Verde": { en: "Cape Verde", zh: "佛得角" },
                "Atlantic/Reykjavik": { en: "Reykjavik", zh: "雷克雅未克" },
                "Australia/Adelaide": { en: "Adelaide", zh: "阿德莱德" },
                "Australia/Brisbane": { en: "Brisbane", zh: "布里斯班" },
                "Australia/Darwin": { en: "Darwin", zh: "达尔文" },
                "Australia/Hobart": { en: "Hobart", zh: "霍巴特" },
                "Australia/Perth": { en: "Perth", zh: "珀斯" },
                "Australia/Sydney": { en: "Sydney", zh: "悉尼" },
                "Australia/Melbourne": { en: "Melbourne", zh: "墨尔本" },
                "America/Los_Angeles": { en: "Los Angeles", zh: "洛杉矶" },
                "Europe/Amsterdam": { en: "Amsterdam", zh: "阿姆斯特丹" },
                "Europe/Athens": { en: "Athens", zh: "雅典" },
                "Europe/Berlin": { en: "Berlin", zh: "柏林" },
                "Europe/Brussels": { en: "Brussels", zh: "布鲁塞尔" },
                "Europe/Bucharest": { en: "Bucharest", zh: "布加勒斯特" },
                "Europe/Budapest": { en: "Budapest", zh: "布达佩斯" },
                "Europe/Copenhagen": { en: "Copenhagen", zh: "哥本哈根" },
                "Europe/Dublin": { en: "Dublin", zh: "都柏林" },
                "Europe/Helsinki": { en: "Helsinki", zh: "赫尔辛基" },
                "Europe/Istanbul": { en: "Istanbul", zh: "伊斯坦布尔" },
                "Europe/Kaliningrad": { en: "Kaliningrad", zh: "加里宁格勒" },
                "Europe/Kiev": { en: "Kiev", zh: "基辅" },
                "Europe/Lisbon": { en: "Lisbon", zh: "里斯本" },
                "Europe/London": { en: "London", zh: "伦敦" },
                "Europe/Madrid": { en: "Madrid", zh: "马德里" },
                "Europe/Moscow": { en: "Moscow", zh: "莫斯科" },
                "Europe/Oslo": { en: "Oslo", zh: "奥斯陆" },
                "Europe/Paris": { en: "Paris", zh: "巴黎" },
                "Europe/Prague": { en: "Prague", zh: "布拉格" },
                "Europe/Rome": { en: "Rome", zh: "罗马" },
                "Europe/Sofia": { en: "Sofia", zh: "索非亚" },
                "Europe/Stockholm": { en: "Stockholm", zh: "斯德哥尔摩" },
                "Europe/Tallinn": { en: "Tallinn", zh: "塔林" },
                "Europe/Vienna": { en: "Vienna", zh: "维也纳" },
                "Europe/Vilnius": { en: "Vilnius", zh: "维尔纽斯" },
                "Europe/Warsaw": { en: "Warsaw", zh: "华沙" },
                "Europe/Zurich": { en: "Zurich", zh: "苏黎世" },
                "Pacific/Auckland": { en: "Auckland", zh: "奥克兰" },
                "Pacific/Chatham": { en: "Chatham", zh: "查塔姆" },
                "Pacific/Fiji": { en: "Fiji", zh: "斐济" },
                "Pacific/Honolulu": { en: "Honolulu", zh: "檀香山" },
                "Pacific/Kiritimati": { en: "Kiritimati", zh: "基里巴斯" },
                "Pacific/Midway": { en: "Midway", zh: "中途岛" },
                "Pacific/Noumea": { en: "Noumea", zh: "努美阿" },
                "Pacific/Pago_Pago": { en: "Pago Pago", zh: "帕果帕果" },
                "Pacific/Port_Moresby": { en: "Port Moresby", zh: "莫尔兹比港" },
                "Pacific/Tongatapu": { en: "Tongatapu", zh: "汤加塔布" },
            };

            const allTimezoneKeys = Object.keys(timezoneDisplayNames);

            const populateTimezoneSelect = (filterTerm = '') => {
                while (timezoneSelect.options.length > 1) {
                    timezoneSelect.remove(1);
                }

                const lowerCaseFilter = filterTerm.toLowerCase();
                const currentLang = languageSwitcher.value;

                allTimezoneKeys.filter(tz => {
                    const displayNameEn = timezoneDisplayNames[tz]['en'].toLowerCase();
                    const displayNameZh = timezoneDisplayNames[tz]['zh'].toLowerCase();
                    const ianaName = tz.toLowerCase();
                    return ianaName.includes(lowerCaseFilter) ||
                           displayNameEn.includes(lowerCaseFilter) ||
                           displayNameZh.includes(lowerCaseFilter);
                }).forEach(tz => {
                    const option = document.createElement('option');
                    option.value = tz;
                    option.textContent = timezoneDisplayNames[tz][currentLang] || timezoneDisplayNames[tz]['en'];
                    timezoneSelect.appendChild(option);
                });
                timezoneSelect.value = "";
                setLanguage(currentLang); // Re-apply language to ensure placeholder and existing card titles are correct
            };

            // Initial population and language application
            populateTimezoneSelect();
            setLanguage(savedLanguage); // Apply language to all elements after initial population

            // Search input event listener
            timezoneSearchInput.addEventListener('input', (event) => {
                populateTimezoneSelect(event.target.value);
            });

            // Add Timezone functionality
            addTimezoneBtn.addEventListener('click', () => {
                const selectedTimezone = timezoneSelect.value;
                if (selectedTimezone && !document.querySelector(`.time-card[data-timezone="${selectedTimezone}"]`)) {
                    const newCard = document.createElement('div');
                    newCard.classList.add('time-card');
                    newCard.setAttribute('data-timezone', selectedTimezone);
                    
                    const currentLang = languageSwitcher.value;
                    const displayCityName = timezoneDisplayNames[selectedTimezone][currentLang] || timezoneDisplayNames[selectedTimezone]['en'];

                    newCard.innerHTML = `
                        <h3 data-timezone-name="${selectedTimezone}">${displayCityName}</h3>
                        <span class="current-time">--:--:--</span>
                        <span class="date-display"></span>
                        <span class="offset-display">---</span>
                        <button class="remove-card" aria-label="Remove card">&times;</button>
                        <button class="fullscreen-btn" data-en="&#x26F6;" data-zh="&#x26F6;" aria-label="Full screen">&#x26F6;</button>
                    `;
                    worldClockDashboard.appendChild(newCard);
                    updateClocks();

                    newCard.querySelector('.remove-card').addEventListener('click', () => {
                        newCard.remove();
                    });

                    if (Sortable.active) {
                        Sortable.active.destroy();
                    }
                    new Sortable(worldClockDashboard, {
                        animation: 150,
                        ghostClass: 'sortable-ghost'
                    });
                } else if (document.querySelector(`.time-card[data-timezone="${selectedTimezone}"]`)) {
                    displayMessage('timezoneAlreadyAdded', 'info'); // Use message key
                } else {
                    displayMessage('selectTimezoneToAdd', 'error'); // Use message key
                }
            });

            // Remove card functionality
            worldClockDashboard.addEventListener('click', (event) => {
                if (event.target.classList.contains('remove-card')) {
                    event.target.closest('.time-card').remove();
                }
            });


            // --- Countdown Timer ---
            const countdownDisplay = document.getElementById('countdown-display');
            const countdownMinutesInput = document.getElementById('countdown-minutes');
            const countdownStartBtn = document.getElementById('countdown-start');
            const countdownPauseBtn = document.getElementById('countdown-pause');
            const countdownResetBtn = document.getElementById('countdown-reset');
            let countdownInterval;
            let timeRemaining = 0; // in seconds

            const formatTime = (totalSeconds) => {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return [hours, minutes, seconds]
                    .map(unit => String(unit).padStart(2, '0'))
                    .join(':');
            };

            countdownStartBtn.addEventListener('click', () => {
                if (timeRemaining === 0) {
                    const minutes = parseInt(countdownMinutesInput.value);
                    if (isNaN(minutes) || minutes <= 0) {
                        displayMessage('invalidCountdownInput', 'error'); // Use message key
                        return;
                    }
                    timeRemaining = minutes * 60;
                }

                if (countdownInterval) clearInterval(countdownInterval);
                countdownInterval = setInterval(() => {
                    if (timeRemaining <= 0) {
                        clearInterval(countdownInterval);
                        countdownDisplay.textContent = "00:00:00";
                        displayMessage('countdownFinished', 'success'); // Use message key
                        return;
                    }
                    timeRemaining--;
                    countdownDisplay.textContent = formatTime(timeRemaining);
                }, 1000);
            });

            countdownPauseBtn.addEventListener('click', () => {
                clearInterval(countdownInterval);
            });

            countdownResetBtn.addEventListener('click', () => {
                clearInterval(countdownInterval);
                timeRemaining = 0;
                countdownDisplay.textContent = "00:00:00";
                countdownMinutesInput.value = '';
            });

            // --- Stopwatch ---
            const stopwatchDisplay = document.getElementById('stopwatch-display');
            const stopwatchStartBtn = document.getElementById('stopwatch-start');
            const stopwatchPauseBtn = document.getElementById('stopwatch-pause');
            const stopwatchResetBtn = document.getElementById('stopwatch-reset');
            let stopwatchInterval;
            let elapsedTime = 0; // in seconds

            stopwatchStartBtn.addEventListener('click', () => {
                if (stopwatchInterval) clearInterval(stopwatchInterval);
                stopwatchInterval = setInterval(() => {
                    elapsedTime++;
                    stopwatchDisplay.textContent = formatTime(elapsedTime);
                }, 1000);
            });

            stopwatchPauseBtn.addEventListener('click', () => {
                clearInterval(stopwatchInterval);
            });

            stopwatchResetBtn.addEventListener('click', () => {
                clearInterval(stopwatchInterval);
                elapsedTime = 0;
                stopwatchDisplay.textContent = "00:00:00";
            });

            // --- Drag and Drop (SortableJS) ---
            if (typeof Sortable !== 'undefined') {
                new Sortable(worldClockDashboard, {
                    animation: 150,
                    ghostClass: 'sortable-ghost'
                });
            } else {
                console.warn('SortableJS library not loaded. Drag and drop functionality will not work. Please include Sortable.min.js');
            }

            // --- Fullscreen functionality ---
            let currentFullscreenElement = null;

            const enterFullscreen = (element) => {
                // Store the original parent to return to
                element.originalParent = element.parentNode;
                element.originalNextSibling = element.nextSibling;

                // Move element to body and add fullscreen class
                body.appendChild(element);
                element.classList.add('fullscreen-overlay');
                body.classList.add('body--fullscreen');
                currentFullscreenElement = element;

                // Create and append close button
                const closeBtn = document.createElement('button');
                closeBtn.classList.add('fullscreen-close-btn');
                const currentLang = languageSwitcher.value;
                closeBtn.textContent = messages['exitFullscreen'][currentLang] || messages['exitFullscreen']['en'];
                closeBtn.addEventListener('click', exitFullscreen);
                element.appendChild(closeBtn);

                // Hide the fullscreen button itself when in fullscreen
                const fsBtn = element.querySelector('.fullscreen-btn');
                if (fsBtn) {
                    fsBtn.style.display = 'none';
                }
            };

            const exitFullscreen = () => {
                if (!currentFullscreenElement) return;

                // Remove close button
                const closeBtn = currentFullscreenElement.querySelector('.fullscreen-close-btn');
                if (closeBtn) {
                    closeBtn.removeEventListener('click', exitFullscreen);
                    closeBtn.remove();
                }

                // Show the fullscreen button again
                const fsBtn = currentFullscreenElement.querySelector('.fullscreen-btn');
                if (fsBtn) {
                    fsBtn.style.display = ''; // Revert to default display
                }

                // Restore element to its original position
                if (currentFullscreenElement.originalNextSibling) {
                    currentFullscreenElement.originalParent.insertBefore(currentFullscreenElement, currentFullscreenElement.originalNextSibling);
                } else {
                    currentFullscreenElement.originalParent.appendChild(currentFullscreenElement);
                }

                currentFullscreenElement.classList.remove('fullscreen-overlay');
                body.classList.remove('body--fullscreen');
                currentFullscreenElement = null;
            };

            // Add event listeners to all fullscreen buttons
            document.querySelectorAll('.fullscreen-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const parentModule = event.target.closest('.time-card') || event.target.closest('.utility-section');
                    if (parentModule) {
                        enterFullscreen(parentModule);
                    }
                });
            });

            // --- Message Box (instead of alert) ---
            const createMessageBox = () => {
                const messageBox = document.createElement('div');
                messageBox.id = 'custom-message-box';
                messageBox.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background-color: var(--card-background-light);
                    border: 1px solid var(--border-light);
                    border-radius: var(--border-radius);
                    padding: 20px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    z-index: 1000;
                    display: none;
                    flex-direction: column;
                    align-items: center;
                    gap: 15px;
                    min-width: 250px;
                    text-align: center;
                    transition: background-color 0.3s ease, border-color 0.3s ease;
                `;
                messageBox.innerHTML = `
                    <p id="message-content" style="margin: 0; font-size: 1.1em;"></p>
                    <button id="message-ok-btn" style="
                        padding: 8px 15px;
                        background-color: var(--primary-color);
                        color: white;
                        border: none;
                        border-radius: var(--border-radius);
                        cursor: pointer;
                        font-size: 1em;
                        transition: background-color 0.2s ease;
                    ">OK</button>
                `;
                document.body.appendChild(messageBox);

                document.getElementById('message-ok-btn').addEventListener('click', () => {
                    messageBox.style.display = 'none';
                });

                // Dark mode styling for message box
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'class' && body.classList.contains('dark-mode')) {
                            messageBox.style.backgroundColor = 'var(--card-background-dark)';
                            messageBox.style.borderColor = 'var(--border-dark)';
                            messageBox.querySelector('#message-content').style.color = 'var(--text-dark)';
                        } else if (mutation.attributeName === 'class' && !body.classList.contains('dark-mode')) {
                            messageBox.style.backgroundColor = 'var(--card-background-light)';
                            messageBox.style.borderColor = 'var(--border-light)';
                            messageBox.querySelector('#message-content').style.color = 'var(--text-light)';
                        }
                    });
                });
                observer.observe(body, { attributes: true });
            };

            const displayMessage = (messageKey, type = 'info') => {
                let messageBox = document.getElementById('custom-message-box');
                if (!messageBox) {
                    createMessageBox();
                    messageBox = document.getElementById('custom-message-box');
                }
                const messageContent = document.getElementById('message-content');
                const currentLang = languageSwitcher.value;
                messageContent.textContent = messages[messageKey][currentLang] || messages[messageKey]['en']; // Get localized message

                if (type === 'error') {
                    messageContent.style.color = '#dc3545';
                } else if (type === 'success') {
                    messageContent.style.color = '#28a745';
                } else {
                    messageContent.style.color = 'var(--text-light)';
                    if (body.classList.contains('dark-mode')) {
                        messageContent.style.color = 'var(--text-dark)';
                    }
                }

                messageBox.style.display = 'flex';
            };
        });
    </script>
</body>
</html>
